"use strict";var ve=Object.create;var B=Object.defineProperty,_e=Object.defineProperties,Ee=Object.getOwnPropertyDescriptor,we=Object.getOwnPropertyDescriptors,Ae=Object.getOwnPropertyNames,Gt=Object.getOwnPropertySymbols,be=Object.getPrototypeOf,Kt=Object.prototype.hasOwnProperty,Se=Object.prototype.propertyIsEnumerable;var Jt=(n,t,e)=>t in n?B(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,P=(n,t)=>{for(var e in t||(t={}))Kt.call(t,e)&&Jt(n,e,t[e]);if(Gt)for(var e of Gt(t))Se.call(t,e)&&Jt(n,e,t[e]);return n},F=(n,t)=>_e(n,we(t));var Re=(n,t)=>{for(var e in t)B(n,e,{get:t[e],enumerable:!0})},tt=(n,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ae(t))!Kt.call(n,r)&&r!==e&&B(n,r,{get:()=>t[r],enumerable:!(s=Ee(t,r))||s.enumerable});return n},f=(n,t,e)=>(tt(n,t,"default"),e&&tt(e,t,"default")),et=(n,t,e)=>(e=n!=null?ve(be(n)):{},tt(t||!n||!n.__esModule?B(e,"default",{value:n,enumerable:!0}):e,n)),xe=n=>tt(B({},"__esModule",{value:!0}),n);var g=(n,t,e)=>new Promise((s,r)=>{var i=c=>{try{a(e.next(c))}catch(l){r(l)}},o=c=>{try{a(e.throw(c))}catch(l){r(l)}},a=c=>c.done?s(c.value):Promise.resolve(c.value).then(i,o);a((e=e.apply(n,t)).next())});var m={};Re(m,{AGENTVERSE_URL:()=>Ct,AGENT_ADDRESS_LENGTH:()=>Rt,AGENT_PREFIX:()=>bt,ALMANAC_API_MAX_RETRIES:()=>Xt,ALMANAC_API_TIMEOUT_SECONDS:()=>Ie,ALMANAC_API_URL:()=>L,ALMANAC_CONTRACT_VERSION:()=>H,ALMANAC_REGISTRATION_WAIT:()=>Pt,ASGI:()=>Ce,AVERAGE_BLOCK_INTERVAL:()=>it,Agent:()=>Me,AlmanacApiResolver:()=>X,AlmanacContractResolver:()=>yt,Context:()=>Et,DEFAULT_ENVELOPE_TIMEOUT_SECONDS:()=>b,DEFAULT_MAX_ENDPOINTS:()=>N,DEFAULT_SEARCH_LIMIT:()=>at,Envelope:()=>R,EnvelopeHistory:()=>Nt,EnvelopeHistoryEntry:()=>It,ErrorMessage:()=>ue,ExternalContext:()=>Ht,GlobalResolver:()=>Z,Identity:()=>S,InternalContext:()=>wt,KeyValueStore:()=>jt,LEDGER_PREFIX:()=>Pe,MAILBOX_POLL_INTERVAL_SECONDS:()=>Ne,MAINNET_CONTRACT_ALMANAC:()=>xt,MAINNET_CONTRACT_NAME_SERVICE:()=>st,MAINNET_PREFIX:()=>q,MAINNET_RPC:()=>j,Model:()=>y,NameServiceResolver:()=>vt,Protocol:()=>Wt,REGISTRATION_DENOM:()=>rt,REGISTRATION_FEE:()=>V,REGISTRATION_RETRY_INTERVAL_SECONDS:()=>Te,REGISTRATION_UPDATE_INTERVAL_SECONDS:()=>zt,RESPONSE_TIME_HINT_SECONDS:()=>Le,Resolver:()=>I,RulesBasedResolver:()=>qt,TESTNET_CONTRACT_ALMANAC:()=>Mt,TESTNET_CONTRACT_NAME_SERVICE:()=>nt,TESTNET_FAUCET:()=>Zt,TESTNET_PREFIX:()=>St,TESTNET_RPC:()=>W,USER_PREFIX:()=>U,WALLET_MESSAGING_POLL_INTERVAL_SECONDS:()=>De,Wallet:()=>cs,deriveKeyFromSeed:()=>se,dispatcher:()=>D,encloseResponse:()=>es,encloseResponseRaw:()=>le,encodeLengthPrefixed:()=>J,generateUserAddress:()=>Fe,isUserAddress:()=>O,mailbox:()=>is,parseAgentverseConfig:()=>ke,parseEndpointConfig:()=>Oe,parseIdentifier:()=>Q,query:()=>os,sendMessage:()=>ge,sendSyncMessage:()=>ts});module.exports=xe(m);f(m,require("util"),module.exports);var Me="tmp";var Ce="tmp";var ce=require("uuid");var bt="agent",Pe="fetch",U="user",St="test-agent",q="agent",Rt=65,xt="fetch1mezzhfj7qgveewzwzdk6lz5sae4dunpmmsjr9u7z0tpmdsae8zmquq3y0y",Mt="fetch1tjagw8g8nn4cwuw00cf0m5tl4l6wfw9c0ue507fhx9e3yrsck8zs0l3q4w",st="fetch1479lwv5vy8skute5cycuz727e55spkhxut0valrcm38x9caa2x8q99ef0q",nt="fetch1mxz8kn3l5ksaftx8a9pj9a6prpzk2uhxnqdkwuqvuh37tw80xu6qges77l",V="500000000000000000",rt="atestfet",zt=3600,Te=60,it=6,H="2.0.0",Ct="https://agentverse.ai",L=`${Ct}/v1/almanac`,Ie=1,Xt=10,Pt=100,Ne=1,De=2,Le=5,b=30,N=10,at=100,W="https://rpc-dorado.fetch.ai",j="https://rpc-fetchhub.fetch.ai",Zt="https://faucet-dorado.fetch.ai";function Oe(n){let t=[];return typeof n=="object"&&!Array.isArray(n)&&n!==null?t=Object.entries(n).map(([e,s])=>({url:e,weight:(s==null?void 0:s.weight)||1})):Array.isArray(n)?t=n.map(e=>({url:e,weight:1})):typeof n=="string"&&(t=[{url:n,weight:1}]),t}function ke(n=null){let t=null,e=Ct,s=null,r=null;return typeof n=="string"?n.includes("@")?[t,e]=n.split("@"):n.includes("://")?e=n:t=n:typeof n=="object"&&n!==null&&(t=n.agent_mailbox_key||null,e=n.base_url||e,r=n.protocol||null),[s,e]=e.includes("://")?e.split("://"):[null,e],s=r||s||"https",{agentMailboxKey:t,baseUrl:e,protocol:s,httpPrefix:s==="wss"||s==="https"?"https":"http",useMailbox:t!==null}}var Yt=require("crypto"),te=require("elliptic"),ct=require("bech32"),K=require("js-sha256");var ee=2e3,$e=256,G=new te.ec("secp256k1");function Be(n,t,e,s=!0){let r=0,i=0,o=[],a=(1<<e)-1,c=(1<<t+e-1)-1;for(let l of n){if(l<0||l>>t)throw new Error("Invalid value");for(r=(r<<t|l)&c,i+=t;i>=e;)i-=e,o.push(r>>i&a)}if(s)i>0&&o.push(r<<e-i&a);else if(i>=t||r<<e-i&a)throw new Error("Invalid padding");return o}function Qt(n){let t=ct.bech32.decode(n,ee),e=Buffer.from(ct.bech32.fromWords(t.words));return[t.prefix,e]}function ot(n,t){let e=Be(t,8,5,!0);return ct.bech32.encode(n,e,ee)}function Fe(){return ot(U,(0,Yt.randomBytes)(32))}function O(n){return n.substring(0,U.length)===U}function Ue(n,t){let e=K.sha256.create();if(e.update(n),!(0<=t&&t<$e))throw new Error("Index out of bounds");return e.update(Buffer.from([t])),Buffer.from(e.digest())}function qe(n){let t=K.sha256.create();return t.update(n),Buffer.from(t.digest())}function se(n,t,e){let s=K.sha256.create();return s.update(Ue(t,e)),s.update(qe(n)),Buffer.from(s.digest())}function J(n){let t;if(typeof n=="string")t=Buffer.from(n);else if(typeof n=="number")t=Buffer.alloc(8),t.writeBigUInt64BE(BigInt(n));else if(Buffer.isBuffer(n))t=n;else throw new Error("Invalid type for encoding");let e=Buffer.alloc(8);return e.writeBigUInt64BE(BigInt(t.length)),Buffer.concat([e,t])}var S=class n{constructor(t){this.keyPair=t;let e=Buffer.from(this.keyPair.getPublic().encode("hex",!0),"hex");this.address=ot("agent",e),this.pubKey=e.toString("hex")}static fromSeed(t,e){let s=se(t,"agent",e),r=G.keyFromPrivate(s);return new n(r)}static generate(){let t=G.genKeyPair();return new n(t)}static fromString(t){let e=G.keyFromPrivate(t,"hex");return new n(e)}get privateKey(){return this.keyPair.getPrivate("hex")}get getAddress(){return this.address}get getPubKey(){return this.pubKey}sign(t){let e=this.keyPair.sign(t),s=this.getCanonicalSignature(e);return ot("sig",s)}signB64(t){let e=this.keyPair.sign(t);return this.getCanonicalSignature(e).toString("base64")}signDigest(t){let e=this.keyPair.sign(t),s=this.getCanonicalSignature(e);return ot("sig",s)}signRegistration(t,e,s){let r=K.sha256.create();return r.update(J(t)),r.update(J(this.address)),r.update(J(e)),r.update(J(s)),this.signDigest(Buffer.from(r.digest()))}signArbitrary(t){let e={chain_id:"",account_number:"0",sequence:"0",fee:{gas:"0",amount:[]},msgs:[{type:"sign/MsgSignData",value:{signer:this.address,data:t.toString("base64")}}],memo:""},s=Buffer.from(JSON.stringify(e,Object.keys(e).sort(),0)),r=this.signB64(s);return[s.toString("base64"),r]}static verifyDigest(t,e,s){let[r,i]=Qt(t),[o,a]=Qt(s);if(r!=="agent")throw new Error("Unable to decode agent address");if(o!=="sig")throw new Error("Unable to decode signature");if(a.length!==64)throw new Error("Invalid signature length");let c=a.subarray(0,32),l=a.subarray(32);if(!G.keyFromPublic(i).verify(e,{r:c,s:l}))throw new Error("Unable to verify signature")}getCanonicalSignature(t){let e=t.r,s=t.s,r=G.curve.n,i=r.shrn(1),o=s;s.gt(i)&&(o=r.sub(s));let a=Buffer.from(e.toArray("be",32)),c=Buffer.from(o.toArray("be",32));return Buffer.concat([a,c])}};var Tt=class{constructor(){this._sinks=new Map}get sinks(){return this._sinks}register(t,e){var r;let s=(r=this._sinks.get(t))!=null?r:new Set;s.add(e),this._sinks.set(t,s)}unregister(t,e){let s=this._sinks.get(t);if(s){if(s.delete(e),s.size===0){this._sinks.delete(t);return}this._sinks.set(t,s)}}contains(t){return this._sinks.has(t)}dispatchMsg(t,e,s,r,i){return g(this,null,function*(){let o=this._sinks.get(e)||new Set;for(let a of o)yield a.handleMessage(t,s,r,i)})}dispatchRest(t,e,s,r){return g(this,null,function*(){let i=this._sinks.get(t)||new Set;for(let o of i)return yield o.handleRest(e,s,r)})}},D=new Tt;var ne=require("js-sha256"),v=require("zod"),R=class n{constructor({version:t,sender:e,target:s,session:r,schemaDigest:i,protocolDigest:o,payload:a,expires:c,nonce:l,signature:p}){this.version=t,this.sender=e,this.target=s,this.session=r,this.schemaDigest=i,this.protocolDigest=o,this.payload=a,this.expires=c,this.nonce=l,this.signature=p}encodePayload(t){this.payload=Buffer.from(t).toString("base64")}decodePayload(){return this.payload?Buffer.from(this.payload,"base64").toString():""}sign(t){try{this.signature=t.signDigest(this._digest())}catch(e){throw new Error(`Failed to sign envelope: ${e}`)}}verify(){if(!this.signature)throw new Error("Envelope signature is missing");console.log("Digest",this._digest().toString("hex")),S.verifyDigest(this.sender,this._digest(),this.signature)}toJSON(){var e,s,r,i,o,a;let t={version:this.version,sender:this.sender,target:this.target,session:this.session,schema_digest:(e=this.schemaDigest)!=null?e:null,protocol_digest:(s=this.protocolDigest)!=null?s:null,payload:(r=this.payload)!=null?r:null,expires:(i=this.expires)!=null?i:null,nonce:(o=this.nonce)!=null?o:null,signature:(a=this.signature)!=null?a:null};return JSON.stringify(t)}_digest(){let t=ne.sha256.create();if(t.update(this.sender),t.update(this.target),t.update(this.session),t.update(this.schemaDigest),this.payload&&t.update(this.payload),this.expires){let e=Buffer.alloc(8);e.writeBigUInt64BE(BigInt(this.expires)),t.update(e)}if(this.nonce!==void 0){let e=Buffer.alloc(8);e.writeBigUInt64BE(BigInt(this.nonce)),t.update(e)}return Buffer.from(t.digest())}static modelValidate(t){var r,i,o,a,c;let s=v.z.object({version:v.z.number(),sender:v.z.string(),target:v.z.string(),session:v.z.string(),schema_digest:v.z.string(),protocol_digest:v.z.string().nullish(),payload:v.z.string().nullish(),expires:v.z.number().nullish(),nonce:v.z.number().nullish(),signature:v.z.string().nullish()}).parse(t);return new n({version:s.version,sender:s.sender,target:s.target,session:s.session,schemaDigest:s.schema_digest,protocolDigest:(r=s.protocol_digest)!=null?r:void 0,payload:(i=s.payload)!=null?i:void 0,expires:(o=s.expires)!=null?o:void 0,nonce:(a=s.nonce)!=null?a:void 0,signature:(c=s.signature)!=null?c:void 0})}},It=class n{constructor({timestamp:t=Math.floor(Date.now()/1e3),version:e,sender:s,target:r,session:i,schemaDigest:o,protocolDigest:a,payload:c}){this.timestamp=t,this.version=e,this.sender=s,this.target=r,this.session=i,this.schemaDigest=o,this.protocolDigest=a,this.payload=c}static fromEnvelope(t){return new n({version:t.version,sender:t.sender,target:t.target,session:t.session,schemaDigest:t.schemaDigest,protocolDigest:t.protocolDigest,payload:t.decodePayload()})}},Nt=class{constructor(){this.envelopes=[]}addEntry(t){this.envelopes.push(t),this.applyRetentionPolicy()}applyRetentionPolicy(){let t=Math.floor(Date.now()/1e3)-86400;this.envelopes=this.envelopes.filter(e=>e.timestamp>=t)}};var Dt=require("zod"),re=et(require("crypto")),gt=require("zod-openapi");(0,gt.extendZodWithOpenApi)(Dt.z);var y=class n{constructor(t){if(!t||!(t instanceof Dt.z.ZodType))throw new Error("Invalid input. Provide a Zod schema.");this.schema=t}validate(t){return this.schema.parse(t)}dumpJson(t){return JSON.stringify(t,null,0)}dump(t){return this.schema.parse(t)}static buildSchemaDigest(t){t instanceof n&&(t=t.schema);let e,{components:s,schema:r}=(0,gt.createSchema)(t,{componentRefPath:"#/definitions/"});console.log(r,s);let i=s?P({definitions:P({},s)},r):r,o=z(i);return console.log(o),`model:${re.default.createHash("sha256").update(o,"utf8").digest("hex")}`}};function z(n){return n===null||typeof n!="object"&&!Array.isArray(n)||Object.keys(n).length===0?JSON.stringify(n):Array.isArray(n)?"["+n.map(z).join(", ")+"]":"{"+Object.keys(n).sort().map(s=>{var i,o;let r=n[s];if(s==="title"&&r==="Properties"||s==="type"&&n.enum&&((i=n.description)!=null&&i.includes("enumeration")))return"";if(s==="$ref")return`"${s}": "${r}"`;if(s==="type"&&r&&typeof r=="object"){if("allOf"in r){let a=(o=r.allOf)==null?void 0:o.find(c=>c.$ref);if(a)return`"${s}": ${z({$ref:a.$ref})}`}else if("$ref"in r)return`"${s}": ${z({$ref:r.$ref})}`}if(s==="required"&&Array.isArray(r)&&n.title==="UAgentResponse")return'"required": ["type"]';if(typeof r=="object"&&r!==null){let a=Object.keys(r);a.includes("type")&&!a.includes("title")&&s!=="Properties"&&(r.title=s.split("_").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "))}return`"${s}": ${z(r)}`}).filter(Boolean).join(", ")+"}"}var k=require("@cosmjs/cosmwasm-stargate");var Ot=0,Lt;function C(n,t){return t.length>Ot&&(Ot=t.length),{logLevel:n,name:t}}function u(n,t){t||(Lt||(Lt=C("INFO","default")),t=Lt);let e=`${t.logLevel}	 [${t.name.padStart(Ot)}]: ${n}`;switch(t.logLevel){case"DEBUG":console.debug(e);break;case"INFO":console.info(e);break;case"WARN":console.warn(e);break;case"ERROR":console.error(e);break}}var _=C("INFO","network"),Ve=1,He=30,kt,$t;function ut(n=!0){return g(this,null,function*(){return n?(kt||(kt=yield k.CosmWasmClient.connect(W)),kt):($t||($t=yield k.CosmWasmClient.connect(j)),$t)})}function We(n){return n?typeof n=="object"&&!Array.isArray(n)?Object.entries(n).map(([t,e])=>({address:t,weight:e.weight||1})):Array.isArray(n)?n.map(t=>({address:t,weight:1})):[{address:n,weight:1}]:null}function pt(r,i){return g(this,arguments,function*(n,t,e=He*1e3,s=Ve*1e3){let o=Date.now();for(;;){try{let a=yield t.getTx(n);if(a)return a}catch(a){}if(Date.now()-o>e)throw new Error("Transaction query timeout");yield new Promise(a=>setTimeout(a,s))}})}var mt=class{constructor(t,e){this.client=t,this.address=e}checkVersion(){return g(this,null,function*(){try{let t=yield this.getContractVersion();return t!==H?(u(`The deployed version of the Almanac Contract is ${t} and you are using version ${H}. Update uAgents to the latest version to enable contract interactions.`,_),!1):!0}catch(t){return u("Failed to query contract version. Contract interactions will be disabled.",_),!1}})}queryContract(t){return g(this,null,function*(){try{let e=yield this.client.queryContractSmart(this.address,t);if(typeof e!="object")throw new Error("Invalid response format");return e}catch(e){throw u(`Query failed: ${e}`,_),e}})}getContractVersion(){return g(this,null,function*(){let t={query_contract_state:{}};return(yield this.queryContract(t)).contract_version})}getAddress(){return this.address}isRegistered(t){return g(this,null,function*(){let e={query_records:{agent_address:t}};return!!(yield this.queryContract(e)).record})}registrationNeedsUpdate(t,e,s,r){return g(this,null,function*(){let[i,o,a]=yield this.queryAgentRecord(t);return!(yield this.isRegistered(t))||i<r||JSON.stringify(e)!==JSON.stringify(o)||JSON.stringify(s)!==JSON.stringify(a)})}queryAgentRecord(t){return g(this,null,function*(){var l,p;let e={query_records:{agent_address:t}},s=yield this.queryContract(e);if(!s.record){let d=yield this.queryContract({query_contract_state:{}});return[(((l=d==null?void 0:d.state)==null?void 0:l.expiry_height)||0)*it,[],[]]}let r=((p=s.record[0])==null?void 0:p.expiry)||0,i=s.height||0,o=(r-i)*it,a=s.record[0].record.service.endpoints.map(d=>({url:d.url,weight:d.weight})),c=s.record[0].record.service.protocols;return[o,a,c]})}getExpiry(t){return g(this,null,function*(){let[e]=yield this.queryAgentRecord(t);return e})}getEndpoints(t){return g(this,null,function*(){let[,e]=yield this.queryAgentRecord(t);return e})}getProtocols(t){return g(this,null,function*(){let[,,e]=yield this.queryAgentRecord(t);return e})}getRegistrationMsg(t,e,s,r,i){return{register:{record:{service:{protocols:t,endpoints:e.map(o=>({url:o.url,weight:o.weight}))}},signature:s,sequence:r,agent_address:i}}}register(t,e,s,r,i,o,a){return g(this,null,function*(){if(!this.address)throw new Error("Contract address not set");let[c]=yield e.getAccounts();if(!c)throw new Error("No account found in wallet");let l=this.getRegistrationMsg(r,i,o,a,s),p=[{denom:rt,amount:V}],d=yield t.execute(c.address,this.address,l,"auto","",p);yield pt(d.transactionHash,this.client)})}registerBatch(t,e,s){return g(this,null,function*(){if(!this.address)throw new Error("Contract address not set");let[r]=yield e.getAccounts();if(!r)throw new Error("No account found in wallet");let i=s.map(a=>{if(a.timestamp===void 0)throw new Error("Agent record is missing timestamp");if(a.signature===void 0)throw new Error("Agent record is not signed");return{typeUrl:"/cosmwasm.wasm.v1.MsgExecuteContract",value:{sender:r.address,contract:this.address,msg:this.getRegistrationMsg(a.protocols,a.endpoints,a.signature,a.timestamp,a.agent_address),funds:[{denom:rt,amount:V}]}}}),o=yield t.signAndBroadcast(r.address,i,"auto");yield pt(o.transactionHash,this.client)})}getSequence(t){return g(this,null,function*(){let e={query_sequence:{agent_address:t}};return(yield this.queryContract(e)).sequence})}},lt=null,dt=null;function Ut(n=!0){return g(this,null,function*(){if(n){if(!dt){let t=yield ut(!0);dt=new mt(t,Mt)}return(yield dt.checkVersion())?dt:null}if(!lt){let t=yield ut(!1);lt=new mt(t,xt)}return(yield lt.checkVersion())?lt:null})}var ht=class{constructor(t,e){this.client=t,this.address=e}queryContract(t){return g(this,null,function*(){try{let e=yield this.client.queryContractSmart(this.address,t);if(typeof e!="object")throw new Error("Invalid response format");return e}catch(e){throw u(`Query failed: ${e}`,_),e}})}isNameAvailable(t,e){return g(this,null,function*(){let s={domain_record:{domain:`${t}.${e}`}};return(yield this.queryContract(s)).is_available})}isOwner(t,e,s){return g(this,null,function*(){let r={permissions:{domain:`${t}.${e}`,owner:s}};return(yield this.queryContract(r)).permissions==="admin"})}isDomainPublic(t){return g(this,null,function*(){var s;let e=(s=yield this.queryContract({query_domain_flags:{domain:t.split(".").pop()}}))==null?void 0:s.domain_flags;return e?e.web3_flags.is_public:!1})}getPreviousRecords(t,e){return g(this,null,function*(){let s={domain_record:{domain:`${t}.${e}`}},r=yield this.queryContract(s);return r.record!==null?r.record.records[0].agent_address.records:[]})}getRegistrationTx(t,e,s,r,i){return g(this,null,function*(){let o=i?nt:st,a={messages:[]};if(yield this.isNameAvailable(t,r)){let c=(yield this.queryContract({contract_state:{}})).price_per_second,l=BigInt(c.amount)*BigInt(86400),p=c.denom;a.messages.push({typeUrl:"/cosmwasm.wasm.v1.MsgExecuteContract",value:{sender:e,contract:o,msg:{register:{domain:`${t}.${r}`}},funds:[{amount:l.toString(),denom:p}]}})}else if(!(yield this.isOwner(t,r,e)))return null;return a.messages.push({typeUrl:"/cosmwasm.wasm.v1.MsgExecuteContract",value:{sender:e,contract:o,msg:{update_record:{domain:`${t}.${r}`,agent_records:s}}}}),a})}register(t,e,s,r,i,o=!0){return g(this,null,function*(){u("Registering name...",_);let a=We(s);if(!a)throw new Error("Invalid record configuration");let[c]=yield e.getAccounts();if(!c)throw new Error("No account found in wallet");let l=(yield t.getChainId())==="dorado-1",p=yield Ut(l);for(let x of a)if(!p||!(yield p.isRegistered(x.address))){u(`Address ${x.address} needs to be registered in almanac contract to be registered in a domain.`,_);return}if(!(yield this.isDomainPublic(i))){u(`Domain ${i} is not public, please select a public domain`,_);return}let d=a;if(!o){let x=yield this.getPreviousRecords(r,i),M=new Map;[...x,...a].forEach(w=>{M.set(`${w.address}_${w.weight}`,w)}),d=Array.from(M.values())}let h=yield this.getRegistrationTx(r,c.address,d,i,l);if(!h){u(`Please select another name, ${r} is owned by another address`,_);return}let E=yield(yield k.SigningCosmWasmClient.connectWithSigner(l?W:j,e)).signAndBroadcast(c.address,h.messages,"auto");yield pt(E.transactionHash,this.client),u("Registering name...complete",_)})}unregister(t,e,s,r=!0){return g(this,null,function*(){if(u("Unregistering name...",_),yield this.isNameAvailable(t,e)){u("Nothing to unregister... (name is not registered)",_);return}let i=yield k.SigningCosmWasmClient.connectWithSigner(r?W:j,s),[o]=yield s.getAccounts();if(!o)throw new Error("No account found in wallet");let a={remove_domain:{domain:`${t}.${e}`}},c=yield i.execute(o.address,this.address,a,"auto");yield pt(c.transactionHash,this.client),u("Unregistering name...complete",_)})}},Bt=null,Ft=null;function ae(n=!0){return g(this,null,function*(){if(n){if(!Ft){let t=yield ut(!0);Ft=new ht(t,nt)}return Ft}if(!Bt){let t=yield ut(!1);Bt=new ht(t,st)}return Bt})}var T=class T{constructor(t){this.faucetUrl=t}getWealth(t){return g(this,null,function*(){let e=yield this.createFaucetClaim(t);if(!e)throw new Error("Unable to create faucet claim");let s=T.MAX_RETRY_ATTEMPTS;for(;s>0;){let r=yield this.checkFaucetClaim(e);if(!r)throw new Error("Failed to check faucet claim status");if(r.status==="complete")break;if(r.status==="failed")throw new Error(`Failed to get wealth for ${t}`);yield new Promise(i=>setTimeout(i,T.POLL_INTERVAL_MS)),s--}if(s===0)throw new Error("Faucet claim check timed out");yield new Promise(r=>setTimeout(r,T.FINAL_WAIT_INTERVAL_MS))})}createFaucetClaim(t){return g(this,null,function*(){try{let e=yield fetch(`${this.faucetUrl}/api/v3/claims`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:t})});return e.ok?(yield e.json()).uuid:null}catch(e){return null}})}checkFaucetClaim(t){return g(this,null,function*(){var e;try{let s=yield fetch(`${this.faucetUrl}/api/v3/claims/${t}`);if(!s.ok)return null;let r=yield s.json();return{txDigest:((e=r.claim.txStatus)==null?void 0:e.hash)||null,status:r.claim.status}}catch(s){return null}})}};T.MAX_RETRY_ATTEMPTS=30,T.POLL_INTERVAL_MS=2e3,T.FINAL_WAIT_INTERVAL_MS=5e3;var ie=T;var oe=C("WARN","resolver");function Vt(n,t=void 0,e=1){return t?t.map(i=>Math.pow(Math.random(),1/i)).map((i,o)=>({value:i,index:o})).sort((i,o)=>o.value-i.value).slice(0,e).map(i=>i.index).map(i=>n[i]):[...n].sort(()=>Math.random()-.5).slice(0,e)}function je(n){return O(n)||n.length===Rt&&n.startsWith(bt)}function Ge(n){return[St,q,""].includes(n)}function Q(n){let t="",e="",s="";return n.includes("://")&&([t,n]=n.split("://",2)),n.includes("/")&&([e,n]=n.split("/",2)),je(n)?s=n:e=n,[t,e,s]}function Je(n,t,e){return g(this,null,function*(){let s=yield Ut(e);if(!s)throw u(`Failed to get Almanac contract for ${e?"testnet":"mainnet"}`),new Error(`Failed to get Almanac contract for ${e?"testnet":"mainnet"}`);let r={query_record:{agent_address:n,record_type:t}};return yield s.queryContract(r)})}function Ke(n,t){return g(this,null,function*(){var i,o;let e={domain_record:{domain:n}},r=yield(yield ae(t)).queryContract(e);if(!r)throw u(`Failed to get NameService contract for ${t?"testnet":"mainnet"}`),new Error(`Failed to get NameService contract for ${t?"testnet":"mainnet"}`);if(r.record!==null){let a=((o=(i=r.record.records[0])==null?void 0:i.agent_address)==null?void 0:o.records)||[];if(a.length>0){let c=a.map(d=>d.address),l=a.map(d=>d.weight),p=Vt(c,l);return p.length>0?p[0]:null}}return null})}var I=class{},yt=class extends I{constructor(t){super(),this._maxEndpoints=t||N}resolve(t){return g(this,null,function*(){var o;let[e,,s]=Q(t),i=yield Je(s,"service",e!==q);if(i){let c=((o=(i.record||{}).service)==null?void 0:o.endpoints)||[];if(c.length>0){let l=c.map(d=>d.url),p=c.map(d=>d.weight);return[s,Vt(l,p,Math.min(this._maxEndpoints,l.length))]}}return[null,[]]})}},X=class extends I{constructor(t,e){super(),this._maxEndpoints=t||N,this._almanacApiUrl=e||L,this._almanacContractResolver=new yt(this._maxEndpoints)}_apiResolve(t){return g(this,null,function*(){try{let[,,e]=Q(t),s=yield fetch(`${this._almanacApiUrl}/agents/${e}`);if(s.status!==200)return s.status!==404&&u(`Failed to resolve agent ${e} from ${this._almanacApiUrl}, resolving via Almanac contract...`,oe),[null,[]];let r=yield s.json(),i=r.expiry;if(!i)return[null,[]];let o=new Date(i),a=new Date,c=r.endpoints||[];if(c.length>0&&o>a){let l=c.map(d=>d.url),p=c.map(d=>d.weight);return[e,Vt(l,p,Math.min(this._maxEndpoints,l.length))]}}catch(e){u(`Error in AlmanacApiResolver when resolving ${t}: ${e}`,oe)}return[null,[]]})}resolve(t){return g(this,null,function*(){let[e,s]=yield this._apiResolve(t);return e!==null?[e,s]:yield this._almanacContractResolver.resolve(t)})}},vt=class extends I{constructor(t){super(),this._maxEndpoints=t||N,this._almanacApiResolver=new X(this._maxEndpoints)}resolve(t){return g(this,null,function*(){let[e,s]=Q(t),i=yield Ke(s,e!==q);return i!==null?yield this._almanacApiResolver.resolve(i):[null,[]]})}},Z=class extends I{constructor(t,e){super(),this._maxEndpoints=t||N,this._almanacApiResolver=new X(this._maxEndpoints,e),this._nameServiceResolver=new vt(this._maxEndpoints)}resolve(t){return g(this,null,function*(){let[e,,s]=Q(t);return Ge(e)?yield(s?this._almanacApiResolver:this._nameServiceResolver).resolve(t):[null,[]]})}},qt=class extends I{constructor(t,e){super(),this._rules=t,this._maxEndpoints=e||N}resolve(t){return g(this,null,function*(){let e=this._rules[t];return typeof e=="string"?e=[e]:e||(e=[]),e.length>this._maxEndpoints&&(e=e.slice(0,this._maxEndpoints)),[t,e]})}};var Xe=C("DEBUG","dispenser");function Ze(n,t,e=!1){return g(this,null,function*(){let s={"content-type":"application/json"};e&&(s["x-uagents-connection"]="sync");let r=[];for(let i of t)try{let o=yield fetch(i,{method:"POST",headers:s,body:JSON.stringify(n)});if(o.ok){if(e){let a=R.modelValidate(yield o.json());if(a.signature){let c=!1;try{a.verify(),c=!0}catch(l){r.push(`Received response envelope that failed verification: ${l}`)}if(!c)continue}return yield Qe(a)}return{status:"delivered",detail:"Message successfully delivered via HTTP",destination:n.target,endpoint:i,session:n.session}}r.push(yield o.text())}catch(o){r.push(`Failed to send message: ${o}`)}return u(`Failed to deliver message to ${n.target} @ ${t}: ${r.join(", ")}`,Xe),{status:"failed",detail:"Message delivery failed",destination:n.target,endpoint:"",session:n.session}})}function Qe(n){return g(this,null,function*(){return D.sinks.size===0?n:(yield D.dispatchMsg(n.sender,n.target,n.schemaDigest,n.decodePayload(),n.session),{status:"delivered",detail:"Sync message successfully delivered via HTTP",destination:n.target,endpoint:"",session:n.session})})}function Ye(c,l,p,d,h,$){return g(this,arguments,function*(n,t,e,s,r,i,o=b,a=!1){let E;if(typeof r=="string"&&O(r)&&(E=r),r||(r=S.generate()),r instanceof S&&(E=r.getAddress),!E)throw new Error("Invalid sender address");i||(i=new Z);let[x,M]=yield i.resolve(n);if(!M||!x)return{status:"failed",detail:"Failed to resolve destination address",destination:n,endpoint:"",session:void 0};let w=new R({version:1,sender:E,target:x,session:(0,ce.v4)(),schemaDigest:t,expires:Math.floor(Date.now()/1e3)+o});w.encodePayload(e),!O(E)&&r instanceof S&&w.sign(r);let A=yield Ze(w,M,a);if(A instanceof R){if(!w.signature)return A;let Y=A.decodePayload();return s?s.modelValidateJson(Y):Y}return A})}function ge(a,c,l,p,d){return g(this,arguments,function*(n,t,e,s,r,i=b,o=!1){return yield Ye(n,y.buildSchemaDigest(t),t.dumpJson(t),e,s,r,i,o)})}function ts(o,a,c,l,p){return g(this,arguments,function*(n,t,e,s,r,i=b){return yield ge(n,t,e,s,r,i,!0)})}function es(n,t,e,s=""){return le(n.dumpJson(n),y.buildSchemaDigest(n),t,e,s)}function le(n,t,e,s,r=""){let i=new R({version:1,sender:e,target:r,session:s,schemaDigest:t});return i.encodePayload(n),JSON.stringify(i,null,0)}var de=require("uuid");var _t=require("zod");var ue=_t.z.object({error:_t.z.string(),details:_t.z.string().optional()}).openapi({title:"ErrorMessage"}),ss=y.buildSchemaDigest(ue);function ns(n){let t="",e="",s="";return n.includes("://")&&([t,n]=n.split("://",2)),n.includes("/")&&([e,n]=n.split("/",2)),rs(n)?s=n:e=n,[t,e,s]}function rs(n){return!0}var Et=class{},wt=class extends Et{constructor(e,s,r,i,o,a,c,l,p){super();this._outboundMessages=new Map;this._agent=e,this._storage=s,this._ledger=r,this._resolver=i,this._dispenser=o,this._logger=p,this._session=a||(0,de.v4)(),this._intervalMessages=c,this._walletMessagingClient=l}get agent(){return this._agent}get storage(){return this._storage}get ledger(){return this._ledger}get logger(){return this._logger||(this._logger={logLevel:"INFO",name:"internal"}),this._logger}get session(){return this._session}get outboundMessages(){return this._outboundMessages}get address(){return this.agent.address}getAgentsByProtocol(i){return g(this,arguments,function*(e,s=at,r){var a;if(!e.startsWith("proto:"))return u(`Invalid protocol digest: ${e}`,r),[];let o=((a=this._resolver._almanacApiResolver)==null?void 0:a._almanacApiUrl)||L;try{let c=yield fetch(`${o}/search`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e.slice(6)}),signal:AbortSignal.timeout(b*1e3)});if(c.ok)return(yield c.json()).filter(d=>d.status==="active").map(d=>d.address).slice(0,s)}catch(c){u(`Failed to query Almanac API: ${c}`,r)}return[]})}broadcast(o,a){return g(this,arguments,function*(e,s,r=at,i=b){let c=yield this.getAgentsByProtocol(e,r,this.logger);if(!c.length)return u(`No active agents found for: ${e}`,this.logger),[];let p=c.filter(h=>h!==this.agent.address).map(h=>this.send(h,s,!1,i)),d=yield Promise.all(p);return u(`Sent ${d.length} messages`,this.logger),d})}_isValidIntervalMessage(e){return this._intervalMessages?this._intervalMessages.has(e):!0}send(o,a){return g(this,arguments,function*(e,s,r=!1,i=b){let c=y.buildSchemaDigest(s),l=JSON.stringify(s.dump({}));return this._isValidIntervalMessage(c)?this.sendRaw(e,c,l,r,i):(u(`Invalid interval message: ${s}`,this.logger),{status:"failed",detail:"Invalid interval message",destination:e,endpoint:"",session:this._session})})}sendRaw(l,p,d){return g(this,arguments,function*(e,s,r,i=!1,o=b,a,c){let[,,h]=ns(e);if(h){if(D.contains(h))return yield D.dispatchMsg(this.agent.address,h,s,r,this._session),{status:"delivered",detail:"Message dispatched locally",destination:h,endpoint:"",session:this._session};if(c!=null&&c.has(h)){let A=c.get(h);return c.delete(h),yield A,{status:"delivered",detail:"Sync message resolved",destination:h,endpoint:"",session:this._session}}this._outboundMessages.set(h,[r,s])}let[$,E]=yield this._resolver.resolve(e);if(!E.length||!$)return u("Unable to resolve destination endpoint",this.logger),{status:"failed",detail:"Unable to resolve destination endpoint",destination:e,endpoint:"",session:this._session};let x=Math.floor(Date.now()/1e3)+o,M=new R({version:1,sender:this.agent.address,target:$,session:this._session,schemaDigest:s,protocolDigest:a,expires:x});M.encodePayload(r),M.sign({signDigest:this.agent.signDigest});let w=new Promise((A,Y)=>{setTimeout(()=>Y(new Error("Timeout")),o*1e3)});this._queueEnvelope(M,E,w,i);try{let A=yield w;return A instanceof R?{status:"delivered",detail:"Sync response received",destination:e,endpoint:E[0]||"",session:this._session}:A}catch(A){return u("Timeout waiting for dispense response",this.logger),{status:"failed",detail:"Timeout waiting for response",destination:e,endpoint:"",session:this._session}}})}_queueEnvelope(e,s,r,i=!1){this._dispenser.addEnvelope(e,s,r,i)}sendWalletMessage(e,s,r=1){return g(this,null,function*(){this._walletMessagingClient?yield this._walletMessagingClient.send(e,s,r):u("Cannot send wallet message: no client available",this.logger)})}},Ht=class extends wt{constructor(t,e,s,r,i,o,a,c,l,p,d,h,$){super(e,s,r,i,o,p,d,h,$),this._queries=a||new Map,this._replies=c,this._messageReceived=t,this._protocol=l||["",null]}_isValidReply(t){if(t===ss)return!0;if(!this._messageReceived)throw new Error("No message received");if(!this._replies)return!0;let e=this._messageReceived,s=this._replies.get(e.schema_digest);return s?s.has(t):!1}send(i,o){return g(this,arguments,function*(t,e,s=!1,r=b){let a=y.buildSchemaDigest(e);return this._isValidReply(a)?this.sendRaw(t,a,JSON.stringify(e.dump({})),s,r,this._protocol[0],this._queries):(u(`Outgoing message '${e.constructor.name}' is not a valid reply to received message: ${this._messageReceived.schema_digest}`,this.logger),{status:"failed",detail:"Invalid reply",destination:t,endpoint:"",session:this._session})})}};var is="tmp";var pe=require("zod"),me=et(require("crypto")),he=require("zod-openapi");(0,he.extendZodWithOpenApi)(pe.z);var as="3.0.2",Wt=class n{constructor(t,e){this._intervalHandlers=[];this._intervalMessages=new Set;this._signedMessageHandlers={};this._unsignedMessageHandlers={};this._models={};this._replies={};this._name=t||"",this._version=e||"0.1.0",this._canonicalName=`${this._name}:${this._version}`,this._digest="",this.spec={title:this._name,version:this._version,openapi_version:as}}get intervals(){return this._intervalHandlers}get models(){return this._models}get replies(){return this._replies}get intervalMessages(){return this._intervalMessages}get signedMessageHandlers(){return this._signedMessageHandlers}get unsignedMessageHandlers(){return this._unsignedMessageHandlers}get name(){return this._name}get version(){return this._version}get canonicalName(){return this._canonicalName}get digest(){return this.manifest().metadata.digest}onInterval(t,e){return s=>(this._addIntervalHandler(t,s,e),s)}_addIntervalHandler(t,e,s){this._intervalHandlers.push([e,t]),s&&(s instanceof Set?s:new Set([s])).forEach(i=>{let o=y.buildSchemaDigest(i);this._intervalMessages.add(o)})}onQuery(t,e){return this.onMessage(t,e,!0)}onMessage(t,e,s=!1){return r=>(this._addMessageHandler(t,r,e,s),r)}_addMessageHandler(t,e,s,r=!1){let i=y.buildSchemaDigest(t);if(this._models[i]=t,r?this._unsignedMessageHandlers[i]=e:this._signedMessageHandlers[i]=e,s){let o=s instanceof Set?s:new Set([s]);this._replies[i]={},o.forEach(a=>{let c=y.buildSchemaDigest(a);this._models[c]=a})}}manifest(){let t={name:this._name,version:this._version},e={version:"1.0",metadata:{},models:[],interactions:[]},s={};Object.entries(this._models).forEach(([a,c])=>{s[a]||(s[a]=c)}),Object.values(this._replies).forEach(a=>{Object.entries(a).forEach(([c,l])=>{s[c]||(s[c]=l)})}),Object.entries(s).forEach(([a,c])=>{e.models.push({digest:a,schema:c.dump({})})}),Object.entries(this._replies).forEach(([a,c])=>{e.interactions.push({type:this._unsignedMessageHandlers[a]?"query":"normal",request:a,responses:Object.keys(c)})});let r=F(P({},e),{metadata:{}}),i=JSON.stringify(r,null,0);return t.digest=n.computeDigest(e),F(P({},e),{metadata:t})}static computeDigest(t){let e=F(P({},t),{metadata:{}}),s=JSON.stringify(e,null,0);return`proto:${me.default.createHash("sha256").update(s).digest("hex")}`}};var os="tmp";var An=C("INFO","AgentRegistration");var At=et(require("fs")),fe=et(require("path"));var ye=require("elliptic"),Rn=new ye.ec("secp256k1"),jt=class{constructor(t,e=null){this._data={};this._name=t||"my";let s=e||process.cwd();this._path=fe.default.join(s,`${this._name}_data.json`),At.default.existsSync(this._path)&&this._load()}get(t){return this._data[t]||null}has(t){return t in this._data}set(t,e){this._data[t]=e,this._save()}remove(t){t in this._data&&(delete this._data[t],this._save())}clear(){this._data={},this._save()}_load(){let t=At.default.readFileSync(this._path,"utf-8");this._data=JSON.parse(t)}_save(){At.default.writeFileSync(this._path,JSON.stringify(this._data,null,4),"utf-8")}};var cs="tmp";0&&(module.exports={AGENTVERSE_URL,AGENT_ADDRESS_LENGTH,AGENT_PREFIX,ALMANAC_API_MAX_RETRIES,ALMANAC_API_TIMEOUT_SECONDS,ALMANAC_API_URL,ALMANAC_CONTRACT_VERSION,ALMANAC_REGISTRATION_WAIT,ASGI,AVERAGE_BLOCK_INTERVAL,Agent,AlmanacApiResolver,AlmanacContractResolver,Context,DEFAULT_ENVELOPE_TIMEOUT_SECONDS,DEFAULT_MAX_ENDPOINTS,DEFAULT_SEARCH_LIMIT,Envelope,EnvelopeHistory,EnvelopeHistoryEntry,ErrorMessage,ExternalContext,GlobalResolver,Identity,InternalContext,KeyValueStore,LEDGER_PREFIX,MAILBOX_POLL_INTERVAL_SECONDS,MAINNET_CONTRACT_ALMANAC,MAINNET_CONTRACT_NAME_SERVICE,MAINNET_PREFIX,MAINNET_RPC,Model,NameServiceResolver,Protocol,REGISTRATION_DENOM,REGISTRATION_FEE,REGISTRATION_RETRY_INTERVAL_SECONDS,REGISTRATION_UPDATE_INTERVAL_SECONDS,RESPONSE_TIME_HINT_SECONDS,Resolver,RulesBasedResolver,TESTNET_CONTRACT_ALMANAC,TESTNET_CONTRACT_NAME_SERVICE,TESTNET_FAUCET,TESTNET_PREFIX,TESTNET_RPC,USER_PREFIX,WALLET_MESSAGING_POLL_INTERVAL_SECONDS,Wallet,deriveKeyFromSeed,dispatcher,encloseResponse,encloseResponseRaw,encodeLengthPrefixed,generateUserAddress,isUserAddress,mailbox,parseAgentverseConfig,parseEndpointConfig,parseIdentifier,query,sendMessage,sendSyncMessage,...require("util")});
